
## 리눅스의 파일 시스템
파일과 디렉터리를 관리하기 위해서는 `파일 시스템`이 필요하다. 리눅스는 초기에 미닉스의 파일 시스템인 `MFS(Minix File System)`을 이용했으나 곧 `ext` 파일 시스템을 사용하게 되었다.

### ext1
- `Extended File System`의 약자로 `extfs`라고도 하며, `MFS`의 기능을 확장했다는 의미
- 파일 시스템의 최대 크기 `2GB`
- inode의 수정과 데이터의 수정 시간 지원이 안되는 문제
- 링크드 리스트로 파일 시스템을 구성하여 시간이 지날수록 복잡해지고 파편화되는 문제

### ext2
- 매우 안정적인 파일 시스템으로 이론적으로 최대 크기 `32TB`까지 지원
- ext3 이전까지 리눅스의 표준 파일 시스템으로 사용됨
- 지금도 부팅 가능한 USB 플래시 드라이브와 기타 SSD 장치에 이용됨

### ext3
- ext2를 기반으로 개발되어 호환이 가능
- `저널링(journaling)` 기능을 도입하여 데이터 복구 기능 강화
- inode의 동적 할당이나 다양한 블록 크기와 같은 최신 파일 시스템 기능 부족

`저널링`은 디스크에 데이터를 기록하기 전에 먼저 `저널에 수정 사항을 기록`하는 기법이다. 만약 디스크에 데이터를 기록하기 전에 갑자기 전원이 나가거나 시스템에 충돌이 발생한 경우, 저널의 기록을 보고 빠르게 데이터를 복구할 수 있다.

### ext4
- 1EB(= 1024TB) 이상의 볼륨과 16TB 이상의 파일을 지원
- ext2 및 ext3와 호환
- 온라인 조각 모음 기능 지원

### xfs
- 실리콘 그래픽스에서 개발한 고성능 저널링 파일 시스템
- CentOS 7부터 ext4와 함께 기본 파일 시스템으로 사용됨
- 64bit 파일 시스템으로 최대 16EB까지 지원


리눅스에서는 표준 파일 시스템 외에도 `유닉스나 Windows 등 타 시스템과 호환`되도록, 또는 `DVD, USB와 같은 외부 저장 장치를 사용`하기 위한 다양한 파일 시스템을 지원한다.
다음은 `[파일 시스템명: 기능]`으로 정리한 리눅스에서 지원하는 주요 파일 시스템 목록이다.
- msdos: MS-DOS 파티션을 사용하기 위한 파일 시스템
- iso9660: CD-ROM, DVD의 표준 파일 시스템으로 읽기 전용으로 사용됨
- nfs(Network File System): 원격 서버의 디스크를 연결할 때 사용
- ufs(Unix File System): 유닉스의 표준 파일 시스템
- vfat: Windows 95, 98, NT를 지원하기 위한 파일 시스템
- ntfs: Windows NTFS를 지원하기 위한 파일 시스템
- hfs: 맥 컴퓨터의 hfs를 지원하기 위한 파일 시스템

### 특수 용도 가상 파일 시스템
리눅스에는 디스크가 아닌 메모리에서 생성되어 사용되는 가상 파일 시스템이 있다.
가상 파일 시스템은 특수한 용도를 가지고 필요에 따라 생기거나 없어진다.
다음은 주요 가상 파일 시스템 목록이다.
- swap: 스왑 영역을 관리하기 위한 스왑 파일 시스템
- tmpfs: 메모리에 임시 파일을 저장하기 위한 파일 시스템, 재시작시 기존 내용 삭제(ex. /tmp)
- proc: 커널의 현재 상태를 나타내는 파일을 가지고 있다 (ex. /proc)
- ramfs: 램 디스크를 지원하는 파일 시스템
- rootfs: 시스템 초기화 및 관리에 필요한 내용 관리 (ex. /)

`/proc/filesystems`의 내용을 보면 현재 커널이 지원하는 파일 시스템의 종류를 볼 수 있다.
파일의 내용에서 1열의 `nodev`는 해당 파일 시스템이 블록 장치(ex. 디스크)와 연결되어 있지 않다는 것으로 `가상 파일 시스템`임을 뜻한다. 또한 `fuseblk`는 `ntfs` 파일 시스템을 연결할 때 사용되는 파일 시스템이다.

---

## ext4 구조
리눅스의 모든 파일 시스템은 기본적으로 유닉스에서 유래된 다음 세가지의 공통 개념을 바탕으로 구현되었다.
- 파일은 inode로 관리된다
- 디렉터리는 단순 파일의 목록을 가지고 있는 `파일`이다
- 특수 파일을 통해 장치에 접근할 수 있다

![](images/linux/ext4.png)

ext4 파일 시스템은 효율적으로 디스크를 사용하기 위해 저장 장치를 논리적인 블록의 집합인 `블록 그룹`으로 구분한다(= 전체 파티션을 여러개의 Block Group으로 나눈다). 일반적으로 블록은 `4KB`이고, 실제 크기는 시스템의 설정에 따라 달라질 수 있다. 블록 그룹에는 세가지 유형이 있다.
1. 블록 그룹 0
	- 파일 시스템의 첫번째 블록 그룹
	- 그룹 0 패딩과 슈퍼블록, 그룹 디스크립터를 가진다.
2. 블록 그룹 a
	- 그룹 0 패딩이 없고, 슈퍼블록과 그룹 디스크립터의 `복사본`을 가진다
3. 블록 그룹 b
	- 그룹 0 패딩, 슈퍼블록, 그룹 디스크립터가 없다.
	- 바로 데이터 블록 비트맵으로 시작한다

#### 그룹 0 패딩
블록 그룹 0의 첫 `1024B`는 x86 부트 섹터와 부가정보를 저장하기 위한 용도로 사용된다.

#### 슈퍼블록
파일 시스템과 관련된 다양한 정보가 저장된다.
- 전체 inode 개수, 할당되지 않은 inode 개수
- 전체 블록 개수, 할당되지 않은 블록 개수
- 첫번째 데이터 블록의 주소
- 그룹당 블록 개수, 블록 크기
- 마운트 시간 등등

슈퍼블록에 문제가 생기면 전체 파일 시스템을 사용할 수 없게 된다. 따라서 슈퍼블록을 다른 블록그룹에 복사해놓고, 블록그룹 0의 슈퍼블록을 읽을 수 없을 경우 복사본을 이용해 복구한다.

#### 그룹 디스크립터와 GDP 예약 블록
`그룹 디스크립터`는 블록 그룹 0에 위치하고 슈퍼블록과 함께 다른 블록 그룹에 복사되어, 블록 그룹 0에 문제 발생시 복구하는데 사용한다. 그룹 디스크립터는 다음과 같은 정보를 저장한다.
`GDP 예약 블록`은 그룹 디스크립터의 확장을 위한 예비 공간이다.
- 블록 비트맵의 주소
- inode 비트맵의 주소
- inode 테이블의 주소
- 할당되지 않은 블록 / inode 개수
- 디렉터리 개수
- 블록 비트맵, inode 비트맵 체크섬

#### 데이터 블록 비트맵과 inode 비트맵
`데이터 블록 비트맵`은 블록 그룹에 포함된 데이터 블록의 사용 여부를 확인하는데 쓰이고,
`inode 비트맵`은 inode 테이블의 항목이 사용 중인지 표시한다.
비트맵에서 각 데이터 블록과 inode 테이블의 항목은 1비트로 표현된다.

#### inode 테이블과 데이터 블록
inode 테이블에 파일 정보를 저장하고, 데이터 블록에는 실제 데이터가 저장된다.

---

## inode 구조

![](images/linux/inode.png)

`inode`는 크게 `파일 정보를 저장하는 부분`과 `실제 파일 내용이 저장되어 있는 데이터 블록의 주소를 저장하는 부분`으로 나누어진다. 

inode에 저장되는 파일 정보는 파일 종류, 파일 접근 권한, 파일 크기, 소유자, 접근 및 수정 시간 등으로 `사용자가 ls -l 명령을 확인하는 정보`를 포함한다.

inode에서 데이터 블록의 주소를 저장하는 부분은 `직접 블록`, `간접 블록`, `이중 간접 블록`으로 구분된다. `직접 블록`은 데이터 블록에 대한 주소를 직접 가지고 있고, `간접 블록`과 `이중 간접 블록`은 데이터 블록에 대한 주소를 가지고 있는 블록에 대한 주소가 지정된다. 데이터 블록의 크기는 시스템 설정에 따라 `1~8KB`까지 지정할 수 있고, 파일의 실제 데이터를 가진 여러 데이터 블록의 목록이 inode에 포함된다.

---

## References
https://ddongwon.tistory.com/66